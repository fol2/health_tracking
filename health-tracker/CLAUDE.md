# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

A comprehensive health tracking Progressive Web App (PWA) built with Next.js 15, featuring fasting tracking, weight monitoring, health metrics, and scheduling capabilities. The app uses PostgreSQL with Prisma ORM, NextAuth.js v5 for authentication, and is deployed on Vercel with a Neon database.

## Common Development Commands

### Development
```bash
npm run dev          # Start development server on http://localhost:3000
npm run build        # Build for production (checks TypeScript)
npm run start        # Start production server
npm run lint         # Run ESLint
npm run format       # Format code with Prettier
```

### Database Management
```bash
npm run db:generate  # Generate Prisma client types
npm run db:push      # Push schema changes (development)
npm run db:migrate   # Create and apply migrations
npm run db:studio    # Open Prisma Studio GUI
npx prisma migrate deploy  # Apply migrations in production
```

### Testing Production Build Locally
```bash
npm run build && npm run start
```

## Architecture Overview

### Authentication Flow (NextAuth.js v5)
- **Main auth config**: `src/lib/auth.ts` - Exports NextAuth configuration with Google OAuth provider
- **Auth wrapper**: `src/lib/auth-helpers.ts` - Provides backward compatibility for v5 changes
- **Auth API route**: `src/app/api/auth/[...nextauth]/route.ts` - Handles all auth endpoints
- **Middleware**: Uses NextAuth callbacks to protect routes and redirect based on auth status

### Database Architecture
- **ORM**: Prisma with PostgreSQL (Neon in production)
- **Connection**: Uses pooled connections via `POSTGRES_PRISMA_URL` and direct connections via `POSTGRES_URL_NON_POOLING`
- **Service Layer Pattern**: All database operations go through service classes in `src/lib/services/`
  - `UserService`: User profiles and preferences
  - `FastingService`: Fasting sessions and statistics
  - `HealthService`: Weight records and health metrics
  - `ScheduleService`: Scheduled fasts and reminders

### State Management
- **Global State**: Zustand stores in `src/store/`
  - `authStore`: User authentication state
  - `fastingStore`: Active fasting session management
  - `healthStore`: Health metrics cache
  - `scheduleStore`: Scheduled fasts cache
- **API Integration**: Custom `useApi` hook in `src/hooks/use-api.ts` for consistent error handling

### Component Architecture
- **UI Components**: `src/components/ui/` - shadcn/ui components with Tailwind CSS
- **Feature Components**: Organized by domain (fasting/, health/, schedule/, analytics/)
- **Layout**: App uses Next.js 15 App Router with nested layouts

### API Routes Structure
All API routes use Next.js 15 route handlers with proper error handling:
- `/api/auth/*` - Authentication endpoints
- `/api/fasting/*` - Fasting session management
- `/api/health/*` - Health metrics and weight tracking
- `/api/schedule/*` - Scheduled fasts and recurring patterns
- `/api/analytics/*` - Data aggregation and exports

### PWA Configuration
- **Service Worker**: Generated by next-pwa, handles offline caching
- **Manifest**: `public/manifest.json` defines app metadata
- **Icons**: Multiple sizes in `public/icons/` for various devices

## Key Technical Considerations

### Next.js 15 Specifics
- Dynamic route parameters are now Promises: `params: Promise<{ id: string }>`
- Use `await params` before accessing values in route handlers
- App Router with server components by default

### TypeScript Strict Mode
- All API responses use Zod validation schemas in `src/lib/validations/`
- Type-safe API calls with proper error handling
- Prisma generates types from schema

### Environment Variables
Required for development:
- `POSTGRES_PRISMA_URL` - PostgreSQL pooled connection (for Prisma queries)
- `POSTGRES_URL_NON_POOLING` - PostgreSQL direct connection (for migrations)
- `DATABASE_URL` - Alternative PostgreSQL connection (legacy support)
- `NEXTAUTH_URL` - Full URL (http://localhost:3000 in dev)
- `NEXTAUTH_SECRET` - Random string for JWT signing
- `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` - OAuth credentials

**Important**: The project uses `.env.local` for local development with Neon PostgreSQL credentials. The `.env` file may contain outdated Prisma Accelerate URLs that won't work. Always check `.env.local` first.

### CSS and Theming
- Tailwind CSS with custom properties for theming
- Dark mode support via next-themes
- CSS variables defined in `src/app/globals.css`
- Avoid using `@apply` with non-existent utility classes

### Deployment Notes
- Deployed to Vercel's Hong Kong region (hkg1)
- Database migrations run automatically via postinstall script
- Environment variables must be set in Vercel dashboard
- Google OAuth redirect URIs must include production domain

## Common Gotchas

1. **Auth Session**: Always check `session.user.hasProfile` before allowing access to app features
2. **Prisma Client**: Run `npm run db:generate` after any schema changes
3. **Type Errors**: Zod v4 uses `.issues` not `.errors` for validation errors
4. **CSS Build Errors**: Use direct CSS properties instead of `@apply` for custom values
5. **API Security**: All API routes check authentication except `/api/auth/*`

## Development Workflow

1. Make changes to code
2. If database schema changed: `npm run db:generate` then `npm run db:push`
3. Test locally with `npm run dev`
4. Run `npm run build` to check for TypeScript errors
5. Format code with `npm run format`
6. Commit changes (credentials are gitignored)
7. Deploy with `vercel --prod` or push to GitHub for auto-deploy