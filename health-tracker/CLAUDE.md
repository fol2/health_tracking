# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

A comprehensive health tracking Progressive Web App (PWA) built with Next.js 15, featuring fasting tracking, weight monitoring, health metrics, and scheduling capabilities. The app uses PostgreSQL with Prisma ORM, NextAuth.js v5 for authentication, and is deployed on Vercel with a Neon database.

## Common Development Commands

### Development
```bash
npm run dev          # Start development server on http://localhost:3000
npm run build        # Build for production (checks TypeScript)
npm run start        # Start production server
npm run lint         # Run ESLint
npm run format       # Format code with Prettier
```

### Database Management
```bash
npm run db:generate  # Generate Prisma client types
npm run db:push      # Push schema changes (development)
npm run db:migrate   # Create and apply migrations
npm run db:studio    # Open Prisma Studio GUI
npx prisma migrate deploy  # Apply migrations in production
```

### Testing
```bash
npm run test              # Run all Playwright tests
npm run test:ui           # Run tests with interactive UI
npm run test:debug        # Debug tests
npm run test:headed       # Run tests with browser visible
npm run test:e2e          # Run E2E tests only
npm run test:components   # Run component tests only
npm run test:chrome       # Run tests in Chrome only
npm run test:mobile       # Run tests on mobile viewports
npm run test:prod         # Test against production URL
npm run test:report       # Show test report
```

### Testing Production Build Locally
```bash
npm run build && npm run start
```

## Architecture Overview

### Authentication Flow (NextAuth.js v5)
- **Main auth config**: `src/lib/auth.ts` - Exports NextAuth configuration with Google OAuth provider
- **Auth wrapper**: `src/lib/auth-helpers.ts` - Provides backward compatibility for v5 changes
- **Auth API route**: `src/app/api/auth/[...nextauth]/route.ts` - Handles all auth endpoints
- **Middleware**: Uses NextAuth callbacks to protect routes and redirect based on auth status

### Database Architecture
- **ORM**: Prisma with PostgreSQL (Neon in production)
- **Connection Types**:
  - `POSTGRES_PRISMA_URL`: Pooled connection for queries (includes `?pgbouncer=true`)
  - `POSTGRES_URL_NON_POOLING`: Direct connection for migrations
  - Both use `?sslmode=require` for secure connections
- **Neon PostgreSQL Features**:
  - Serverless PostgreSQL with autoscaling
  - Connection pooling via PgBouncer
  - Branching for development environments
  - Database in eu-west-2 (London) region
- **Service Layer Pattern**: All database operations go through service classes in `src/lib/services/`
  - `UserService`: User profiles and preferences
  - `FastingService`: Fasting sessions and statistics
  - `HealthService`: Weight records and health metrics
  - `ScheduleService`: Scheduled fasts and reminders
  - `ReminderService`: Reminder notifications and management

### State Management
- **Global State**: Zustand stores in `src/store/`
  - `authStore`: User authentication state
  - `fastingStore`: Active fasting session management
  - `healthStore`: Health metrics cache
  - `scheduleStore`: Scheduled fasts cache
- **API Integration**: Custom `useApi` hook in `src/hooks/use-api.ts` for consistent error handling

### Component Architecture
- **UI Components**: `src/components/ui/` - shadcn/ui components with Tailwind CSS
- **Feature Components**: Organized by domain (fasting/, health/, schedule/, analytics/)
- **Layout**: App uses Next.js 15 App Router with nested layouts

### API Routes Structure
All API routes use Next.js 15 route handlers with proper error handling:
- `/api/auth/*` - Authentication endpoints
- `/api/fasting/*` - Fasting session management
- `/api/health/*` - Health metrics and weight tracking
- `/api/schedule/*` - Scheduled fasts and recurring patterns
- `/api/analytics/*` - Data aggregation and exports

### PWA Configuration
- **Service Worker**: Generated by next-pwa, handles offline caching
- **Manifest**: `public/manifest.json` defines app metadata
- **Icons**: Multiple sizes in `public/icons/` for various devices
- **Config**: `next.config.ts` uses next-pwa with:
  - Auto-registration enabled
  - Skip waiting for immediate updates
  - Disabled in development to avoid caching issues
  - Service worker output to `public/` directory

## Key Technical Considerations

### Next.js 15 Specifics
- Dynamic route parameters are now Promises: `params: Promise<{ id: string }>`
- Use `await params` before accessing values in route handlers
- App Router with server components by default

### TypeScript Strict Mode
- All API responses use Zod validation schemas in `src/lib/validations/`
- Type-safe API calls with proper error handling
- Prisma generates types from schema

### Environment Variables

#### Development (.env.local)
```env
# Neon PostgreSQL
POSTGRES_PRISMA_URL="postgres://neondb_owner:npg_rq4gbwp8KjZc@ep-patient-tooth-abxi0b34-pooler.eu-west-2.aws.neon.tech/neondb?sslmode=require"
POSTGRES_URL_NON_POOLING="postgres://neondb_owner:npg_rq4gbwp8KjZc@ep-patient-tooth-abxi0b34.eu-west-2.aws.neon.tech/neondb?sslmode=require"

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="fwyhLVNGn69m+XRjWk/AlSricgttBZC42yEgpo6x/V4="

# Google OAuth
GOOGLE_CLIENT_ID="[Your Google OAuth Client ID].apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="[Your Google OAuth Client Secret]"

# Demo Mode (optional)
USE_DEMO_AUTH="false"
```

#### Production (Vercel Dashboard)
- `POSTGRES_*` variables are automatically added when creating Vercel Postgres database
- `NEXTAUTH_URL` must be `https://health-tracker-neon.vercel.app` (or your custom domain)
- `NEXTAUTH_SECRET` must be a secure random string (32+ chars)
- Same Google OAuth credentials as development (unless using separate OAuth app)

**Important**: 
- The project uses `.env.local` for local development
- Never commit `.env.local` to version control
- Never commit real OAuth credentials to the repository
- Always use placeholders in documentation and example files
- The `.env` file may contain outdated Prisma Accelerate URLs that won't work

### CSS and Theming
- Tailwind CSS with custom properties for theming
- Dark mode support via next-themes
- CSS variables defined in `src/app/globals.css`
- Avoid using `@apply` with non-existent utility classes

### Deployment Configuration

#### Region Configuration
- **Deployment Region**: London (`lhr1`) - configured in `vercel.json`
- **Database Region**: EU West 2 (London) - Neon PostgreSQL
- **Benefits**: Low latency between app and database, optimal for UK/EU users
- **To Change Region**: Update `"regions": ["lhr1"]` in `vercel.json`

#### Vercel Setup
1. **Project Settings**:
   - Framework Preset: Next.js
   - Build Command: `npm run build` (default)
   - Output Directory: `.next` (default)
   - Install Command: `npm install` (triggers postinstall for Prisma)
   - Node.js Version: 18.x or higher

2. **Functions Configuration**:
   - Functions inherit deployment region automatically
   - No separate configuration needed

3. **Security Headers** (configured in `vercel.json`):
   - CORS headers for API routes
   - X-Content-Type-Options: nosniff
   - X-Frame-Options: DENY
   - X-XSS-Protection: 1; mode=block

4. **Database Setup (Vercel Postgres/Neon)**:
   - Create database via Vercel Dashboard â†’ Storage â†’ Postgres
   - Select matching region for lowest latency
   - Connection pooling enabled by default
   - Automatically sets all `POSTGRES_*` environment variables

#### Google OAuth Configuration
1. **Google Cloud Console Setup**:
   - Enable Google+ API in your project
   - Create OAuth 2.0 Client ID (Web application type)
   
2. **Required Redirect URIs**:
   ```
   # Production
   https://health-tracker-neon.vercel.app/api/auth/callback/google
   
   # Development
   http://localhost:3000/api/auth/callback/google
   ```

3. **Common OAuth Issues**:
   - Redirect URI mismatch: Ensure exact match including protocol
   - Missing trailing slashes can cause failures
   - Update URIs when domain changes

#### Production Deployment Checklist
1. Set all environment variables in Vercel Dashboard
2. Verify Google OAuth redirect URIs
3. Database migrations run automatically via `postinstall` script
4. For manual migrations: `npx prisma migrate deploy`
5. Monitor deployment logs for any errors

## Testing Strategy

### Playwright Configuration
- **Test Directory**: `./tests/` contains all test files
- **Projects**: Tests run on Chrome, Firefox, Safari, and mobile viewports
- **Base URL**: `http://localhost:3000` (automatically starts dev server)
- **Artifacts**: Screenshots on failure, traces on retry, HTML report

### Running Tests
```bash
# Run specific test file
npm run test tests/e2e/auth.spec.ts

# Run tests in headed mode (see browser)
npm run test -- --headed

# Run single test by name
npm run test -- -g "should create fasting session"

# Generate test code with codegen
npx playwright codegen http://localhost:3000
```

## Common Gotchas

1. **Auth Session**: Always check `session.user.hasProfile` before allowing access to app features
2. **Prisma Client**: Run `npm run db:generate` after any schema changes
3. **Type Errors**: Zod v4 uses `.issues` not `.errors` for validation errors
4. **CSS Build Errors**: Use direct CSS properties instead of `@apply` for custom values
5. **API Security**: All API routes check authentication except `/api/auth/*`
6. **Demo Mode**: Set `USE_DEMO_AUTH=true` for testing without Google OAuth

## Development Workflow

1. Make changes to code
2. **IMPORTANT**: After editing any file, ALWAYS use the `code-simplifier` agent to review and improve the code (as specified in root CLAUDE.md)
3. If database schema changed: `npm run db:generate` then `npm run db:push`
4. Test locally with `npm run dev`
5. Run `npm run build` to check for TypeScript errors
6. Run `npm run lint` to check for linting issues
7. Run `npm run format` to format code
8. Run `npm run test` to execute Playwright tests
9. Commit changes (credentials are gitignored)
10. Deploy with `vercel --prod` or push to GitHub for auto-deploy

## Database Schema Overview

Key models and relationships:
- **User**: Core user account (NextAuth managed)
- **UserProfile**: Extended user info (height, timezone, preferences)
- **FastingSession**: Tracks fasting periods with start/end times
- **WeightRecord**: Weight measurements over time
- **HealthMetric**: Flexible JSON storage for various health metrics
- **ScheduledFast**: Future and recurring fasting plans
- **Reminder**: Notification scheduling for fasts and health checks

All models include proper indexes for performance and cascade deletion for data integrity.

## Quick Deployment Reference (Updated)

### First-time Deployment to Vercel
```bash
# Via CLI
vercel --prod

# Via GitHub
# 1. Push to GitHub
# 2. Import at vercel.com/new
# 3. Auto-detects Next.js settings
```

### Environment Variables (Vercel Dashboard)
```env
# Required for production
NEXTAUTH_URL=https://health-tracker-neon.vercel.app
NEXTAUTH_SECRET=[Generate with: openssl rand -base64 32]
GOOGLE_CLIENT_ID=[Your Google OAuth Client ID]
GOOGLE_CLIENT_SECRET=[Your Google OAuth Client Secret]

# Auto-added by Vercel Postgres
POSTGRES_URL=
POSTGRES_PRISMA_URL=
POSTGRES_URL_NON_POOLING=
# ... other POSTGRES_* vars
```

### Common Deployment Commands
```bash
# Pull production env vars locally
vercel env pull .env.production.local

# Run production migrations
npx prisma migrate deploy

# Check production logs
vercel logs --prod

# Redeploy production
vercel --prod --force
```

## Step-by-Step Deployment Guide

### Quick Deployment (Most Common)
```bash
# Deploy directly to production
vercel --prod
```

### Deployment with Git Workflow
```bash
# 1. Check current git status
git status

# 2. Add modified files
git add <file1> <file2>
# Or add all changes
git add .

# 3. Create commit with meaningful message
git commit -m "Your descriptive commit message"

# 4. Deploy to production
vercel --prod
```

### Example Deployment After Bug Fix
```bash
# 1. Fix the bug in your code
# 2. Use code-simplifier to review changes (IMPORTANT!)
# 3. Test the fix locally
npm run dev

# 4. Build to check for errors
npm run build

# 5. Stage and commit changes
git add src/components/health/bmi-trend-chart.tsx
git commit -m "Fix BMI trend chart not loading profile data

Fixed issue where BMI trend chart showed insufficient profile data
even when user had already set their height.

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 6. Deploy to production
vercel --prod
```

### Deployment Output
When you run `vercel --prod`, you'll see:
1. **Instant URL**: A preview URL (e.g., `https://health-tracker-abc123.vercel.app`)
2. **Build Progress**: Shows compilation, type checking, and page generation
3. **Production URL**: Final production URL after successful deployment

### Verifying Deployment
After deployment, always verify:
1. Visit the production URL
2. Test the specific feature you changed
3. Check browser console for any errors
4. Monitor Function Logs in Vercel Dashboard if needed

## Deployment Troubleshooting

### Common Issues and Solutions

1. **Database Connection Failures**
   - Verify all `POSTGRES_*` env vars are set in Vercel
   - Ensure database and deployment regions match
   - Check connection string includes `?sslmode=require`
   - For pooled connections, ensure `?pgbouncer=true` is included

2. **Google OAuth Errors**
   - "redirect_uri_mismatch": Check exact URI in Google Console
   - Include both www and non-www variants if using custom domain
   - NEXTAUTH_URL must match your production URL exactly

3. **Build Failures**
   - "Cannot find module": Run `npm install` locally and commit `package-lock.json`
   - TypeScript errors: Run `npm run build` locally first
   - Prisma errors: Ensure `postinstall` script runs `prisma generate`

4. **Runtime Errors**
   - Check Function Logs in Vercel Dashboard
   - "Invalid NEXTAUTH_SECRET": Must be 32+ characters
   - "Database schema drift": Run `npx prisma migrate deploy`

5. **PWA Issues**
   - Clear browser cache and service worker
   - Check manifest.json is accessible at `/manifest.json`
   - Verify HTTPS is enabled (required for PWA)